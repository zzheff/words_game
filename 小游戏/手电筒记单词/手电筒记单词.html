<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flashlight Words - Stage Light</title>
<style>
body,html{margin:0;padding:0;height:100%;background:#030720;font-family:Arial,sans-serif;}
.stage{position:relative;width:100%;height:100vh;overflow:hidden;}
.scene{position:absolute;inset:0;background:#030720;}

/* 光圈 */
.overlay {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index:5;
  background: transparent;
}
.overlay::before {
  content:'';
  position:absolute;
  left:var(--x,50%);
  top:var(--y,50%);
  width:150px;      /* 光圈直径，可调 */
  height:150px;
  transform: translate(-50%,-50%);
  border-radius:50%;
  /* 从中心亮黄色到边缘透明 */
  background: radial-gradient(circle, 
              rgba(255, 255, 0, 0.6) 0%,    /* 中心亮黄 */
              rgba(255, 255, 0, 0.2) 50%,   /* 中间淡黄 */
              rgba(255, 255, 0, 0) 100%);   /* 边缘透明 */
  pointer-events: none;
}

/* 热点 */
.hotspots{position:absolute;inset:0;z-index:10;}
.hotspot{position:absolute;}
.star{
  width:6px;height:6px;border-radius:50%;
  background:rgba(255,255,100,0.7);
  transform:translate(-50%,-50%) scale(1);
  box-shadow:0 0 3px rgba(255,255,150,0.8);
  z-index:10;
}
.word{
  position:absolute;transform:translate(-50%,-130%);
  white-space:nowrap;padding:6px 10px;background:#fff;color:#000;font-weight:bold;font-size:18px;
  border-radius:6px;box-shadow:0 3px 12px rgba(0,0,0,0.5);display:none;
  z-index:15;
}

.controls{position:absolute;top:10px;left:10px;display:flex;gap:10px;z-index:20;}
.controls button{padding:6px 12px;border:none;border-radius:5px;background:#3a5f8f;color:#fff;cursor:pointer;}
</style>
</head>
<body>
<div class="stage" id="stage">
  <div class="scene"></div>
  <div class="hotspots" id="hotspots"></div>
  <div class="overlay" id="overlay"></div>
  <div class="controls">
    <button id="importBtn">导入单词</button>
    <button id="refreshBtn">刷新单词显示</button>
  </div>
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>
</div>

<script>
let HOTSPOTS = [];
const stage = document.getElementById('stage');
const hotspotsEl = document.getElementById('hotspots');
const overlay = document.getElementById('overlay');
const clickSound = document.getElementById('clickSound');

// 生成不重叠位置
function generatePosition(existing, minDistance=80){
  let x,y,valid;
  for(let i=0;i<100;i++){
    x = Math.random()*80+10;
    y = Math.random()*80+10;
    valid = true;
    for(const h of existing){
      if(!h._el) continue;
      const hx = parseFloat(h._el.style.left);
      const hy = parseFloat(h._el.style.top);
      const dx = x - hx;
      const dy = y - hy;
      if(Math.hypot(dx*10, dy*10)<minDistance){
        valid = false;
        break;
      }
    }
    if(valid) break;
  }
  return {x,y};
}

// 创建热点
function createHotspots(){
  hotspotsEl.innerHTML='';
  HOTSPOTS.forEach(h=>{
    const el = document.createElement('div');
    el.className='hotspot';
    const pos = generatePosition(HOTSPOTS);
    el.style.left = pos.x + '%';
    el.style.top = pos.y + '%';

    const word = document.createElement('div');
    word.className='word';
    word.textContent = Math.random()<0.5?h.chinese:h.english;
    el.appendChild(word);

    const star = document.createElement('div');
    star.className='star';
    el.appendChild(star);

    hotspotsEl.appendChild(el);
    h._el = el;
    h._wordEl = word;
    h._starEl = star;
    h.flickerPhase = Math.random()*Math.PI*2;
    h.flickerSpeed = 0.07 + Math.random()*0.07;
  });
}

// 设置光圈位置
function setSpot(xPct, yPct){
  overlay.style.setProperty('--x', xPct + '%');
  overlay.style.setProperty('--y', yPct + '%');
}

// 检测光圈范围内的单词
function checkIlluminated(clientX,clientY){
  const rect = stage.getBoundingClientRect();
  const spotRadius = 80;
  HOTSPOTS.forEach(h=>{
    const hx = rect.left + rect.width*(parseFloat(h._el.style.left)/100);
    const hy = rect.top + rect.height*(parseFloat(h._el.style.top)/100);
    const dist = Math.hypot(clientX-hx, clientY-hy);
    if(dist<=spotRadius){
      h._wordEl.style.display='block';
      h._starEl.style.display='none';
    }else{
      h._wordEl.style.display='none';
      h._starEl.style.display='block';
    }
  });
}

// 鼠标或触摸移动
function handlePointer(x,y){
  const rect = stage.getBoundingClientRect();
  let xPct = ((x-rect.left)/rect.width)*100;
  let yPct = ((y-rect.top)/rect.height)*100;
  xPct = Math.max(0,Math.min(100,xPct));
  yPct = Math.max(0,Math.min(100,yPct));
  setSpot(xPct,yPct);
  checkIlluminated(x,y);
}

window.addEventListener('mousemove',e=>handlePointer(e.clientX,e.clientY));
window.addEventListener('touchmove',e=>{
  const t = e.touches[0]; if(!t) return;
  handlePointer(t.clientX,t.clientY);
});

// 导入 CSV 单词
document.getElementById('importBtn').addEventListener('click',()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='.csv';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
      const text = evt.target.result;
      const lines = text.split(/\r?\n/).slice(0,15);
      lines.forEach(line=>{
        const [chinese,english]=line.split(',');
        if(chinese && english) HOTSPOTS.push({chinese:chinese.trim(),english:english.trim()});
      });
      createHotspots();
    };
    reader.readAsText(file,'UTF-8');
  };
  input.click();
});

// 刷新单词显示
document.getElementById('refreshBtn').addEventListener('click',()=>{
  clickSound.currentTime=0; clickSound.play();
  HOTSPOTS.forEach(h=>{
    h._wordEl.textContent=Math.random()<0.5?h.chinese:h.english;
  });
});

// 星星闪烁动画
function animateStars(){
  HOTSPOTS.forEach(h=>{
    if(h._starEl && h._starEl.style.display!=='none'){
      h.flickerPhase += h.flickerSpeed;
      const opacity = 0.4 + 0.6*(Math.sin(h.flickerPhase)+1)/2;
      const scale = 0.7 + 0.6*(Math.sin(h.flickerPhase)+1)/2;
      h._starEl.style.opacity = opacity;
      h._starEl.style.transform = `translate(-50%,-50%) scale(${scale})`;
    }
  });
  requestAnimationFrame(animateStars);
}
requestAnimationFrame(animateStars);
</script>
</body>
</html>
