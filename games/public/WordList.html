<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é€‰æ‹©è¯è¡¨</title>
<style>
  :root {
    --bg: #f3f7fb;
    --card: #fff;
    --accent: #5b9bd5;
    --accent2: #4caf50;
    --shadow: 0 4px 10px rgba(0,0,0,0.08);
    --font: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
  }
  body { background: var(--bg); font-family: var(--font); margin: 0; padding: 20px; }
  h1 { text-align: center; color: #333; }
  .container { max-width: 700px; margin: 0 auto; background: var(--card); box-shadow: var(--shadow); border-radius: 16px; padding: 20px; }
  .wordlist, .builtin-list { display: flex; flex-wrap: wrap; gap: 10px; }
  .wordlist button, .builtin-list button { flex: 1 1 45%; background: var(--accent); color: white; border: none; border-radius: 8px; padding: 10px; cursor: pointer; font-size: 16px; transition: 0.2s; }
  .wordlist button:hover, .builtin-list button:hover { opacity: 0.85; }
  .custom-list { margin-top: 20px; }
  .custom-list h2 { font-size: 18px; margin-bottom: 8px; }
  input, textarea { width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
  button.create { background: var(--accent2); color: white; border: none; padding: 10px 20px; margin-top: 10px; border-radius: 8px; cursor: pointer; }
  .lists { margin-top: 20px; }
  .lists ul { list-style: none; padding: 0; }
  .lists li { background: #eef5ff; border-radius: 6px; padding: 8px 10px; margin-bottom: 5px; display: flex; justify-content: space-between; }
  .lists li span { color: #333; }
  .lists li button { background: #ff6666; border: none; color: white; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
</style>
</head>
<body>

<h1>é€‰æ‹©æˆ–åˆ›å»ºè¯è¡¨</h1>
<div class="container">
  <!-- å†…ç½®è¯è¡¨ -->
  <h2>ğŸ“˜ å†…ç½®è¯è¡¨</h2>
  <div class="builtin-list" id="builtinList"></div>

  <!-- è‡ªå®šä¹‰è¯è¡¨ -->
  <div class="custom-list">
    <h2>âœï¸ åˆ›å»ºè‡ªå®šä¹‰è¯è¡¨</h2>
    <input id="listName" placeholder="è¯·è¾“å…¥è¯è¡¨åç§°ï¼Œå¦‚â€˜Unit 1 å•è¯â€™">
    <textarea id="wordPairs" rows="5" placeholder="è¾“å…¥å•è¯å’Œä¸­æ–‡ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¦‚ï¼šapple,è‹¹æœ\nbook,ä¹¦"></textarea>
    <button class="create" onclick="createCustomList()">åˆ›å»ºè¯è¡¨</button>
  </div>

  <div class="lists">
    <h2>ğŸ“š æˆ‘çš„è‡ªå®šä¹‰è¯è¡¨</h2>
    <ul id="customLists"></ul>
  </div>
</div>

<script>
  // ========== è®©é¡µé¢çŸ¥é“è·³å›å“ªé‡Œï¼ˆä¸»é¡µé¢å¸¦?returnURL=xxx è¿›æ¥ï¼‰ ==========
  const params = new URLSearchParams(window.location.search);
  const returnURL = params.get("returnURL") || "../index.html";
  const vocabData = [
    {
      "name": "å¤–ç ”ç¤¾ä¸€å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾ä¸€å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾äºŒå¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾äºŒå¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾äº”å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾äº”å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾äº”å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾äº”å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾å…­å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾å…­å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾å››å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾å››å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "å¤–ç ”ç¤¾å››å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰",
      "type": "file",
      "path": "words/å°å­¦/å¤–ç ”ç¤¾å››å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰.csv"
    },
    {
      "name": "æµ‹è¯•è¯æ±‡",
      "type": "file",
      "path": "words/æµ‹è¯•/æµ‹è¯•è¯æ±‡.csv"
    }
  ];

  // ====== è‡ªå®šä¹‰è¯è¡¨é€»è¾‘ ======
  const customLists = JSON.parse(localStorage.getItem('customLists') || '[]');
  const ul = document.getElementById('customLists');
  renderLists();

  function renderLists() {
    ul.innerHTML = '';
    customLists.forEach((list, index) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>${list.name}ï¼ˆ${list.words.length} ä¸ªè¯ï¼‰</span>
        <div>
          <button onclick="loadList(${index})">åŠ è½½</button>
          <button onclick="deleteList(${index})">åˆ é™¤</button>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  function createCustomList() {
    const name = document.getElementById('listName').value.trim();
    const raw = document.getElementById('wordPairs').value.trim();
    if (!name || !raw) return alert('è¯·è¾“å…¥è¯è¡¨åå’Œå•è¯å†…å®¹');

    const lines = raw.split('\n').map(l => l.split(',')).filter(a => a.length === 2);
    const words = lines.map(([en, cn]) => ({ en: en.trim(), cn: cn.trim() }));

    customLists.push({ name, words });
    localStorage.setItem('customLists', JSON.stringify(customLists));
    renderLists();
    alert('âœ… åˆ›å»ºæˆåŠŸ');
  }

  function deleteList(index) {
    if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªè¯è¡¨å—ï¼Ÿ')) {
      customLists.splice(index, 1);
      localStorage.setItem('customLists', JSON.stringify(customLists));
      renderLists();
    }
  }

  // --- ğŸ“± åŠ è½½è¯è¡¨ â†’ ä¿å­˜åˆ° localStorage â†’ è·³å›ä¸»é¡µé¢ ---
  function loadList(index) {
    const list = customLists[index];
    const csvText = list.words.map(w => `${w.en},${w.cn}`).join('\n');

    localStorage.setItem("csv_data", csvText); // ç»™ä¸»é¡µé¢çš„æ•°æ®
    window.location.href = returnURL; // è¿”å›ä¸»é¡µé¢
  }

  // ===== å†…ç½®è¯è¡¨é€»è¾‘ =====
  const builtinContainer = document.getElementById('builtinList');
  const folderMap = {};

  vocabData.forEach(item => {
    const parts = item.path.split('/');
    const folder = parts[1]; 
    const file = parts[2];   
    if (!folderMap[folder]) folderMap[folder] = [];
    folderMap[folder].push(file);
  });

  function renderFolders() {
    builtinContainer.innerHTML = '';
    Object.keys(folderMap).forEach(folderName => {
      const btn = document.createElement('button');
      btn.textContent = folderName;
      btn.onclick = () => renderCSVList(folderName);
      builtinContainer.appendChild(btn);
    });
  }

  function renderCSVList(folderName) {
    builtinContainer.innerHTML = '';
    const backBtn = document.createElement('button');
    backBtn.textContent = 'â¬… è¿”å›';
    backBtn.onclick = () => renderFolders();
    builtinContainer.appendChild(backBtn);

    folderMap[folderName].forEach(file => {
      const btn = document.createElement('button');
      btn.textContent = file.replace('.csv', '');
      btn.onclick = async () => {
        const csvPath = `./words/${folderName}/${file}`; // âœ… ä¿®æ­£è·¯å¾„
        try {
          const res = await fetch(csvPath);
          if (!res.ok) throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');
          const text = await res.text();
          const lines = text.trim().split(/\r?\n/).map(l => l.split(',')).filter(a => a.length === 2);
          const words = lines.map(([en, cn]) => ({ en: en.trim(), cn: cn.trim() }));

          // âœ… æ”¯æŒå¼¹çª—æˆ–æ™®é€šé¡µé¢ä¸¤ç§æƒ…å†µ
          if (window.opener && !window.opener.closed) {
            window.opener.localStorage.setItem('csv_data', words.map(w => `${w.en},${w.cn}`).join('\n'));
            window.close(); // å…³é—­å¼¹çª—
          } else {
            localStorage.setItem('csv_data', words.map(w => `${w.en},${w.cn}`).join('\n'));
            window.location.href = returnURL;
          }
        } catch (err) {
          alert('âŒ æ— æ³•åŠ è½½æ–‡ä»¶: ' + err.message);
        }
      };
      builtinContainer.appendChild(btn);
    });
  }

  // åˆå§‹åŠ è½½
  renderFolders();

</script>
</body>
</html>
