<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é€‰æ‹©è¯è¡¨</title>
<style>
  :root {
    --bg: #f3f7fb;
    --card: #fff;
    --accent: #5b9bd5;
    --accent2: #4caf50;
    --shadow: 0 4px 10px rgba(0,0,0,0.08);
    --font: "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
  }
  body { background: var(--bg); font-family: var(--font); margin: 0; padding: 20px; }
  h1 { text-align: center; color: #333; }
  .container { max-width: 700px; margin: 0 auto; background: var(--card); box-shadow: var(--shadow); border-radius: 16px; padding: 20px; }
  .builtin-list, .custom-list, .lists { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
  .builtin-list button, .custom-list button, .lists button { flex: 1 1 45%; background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 10px; cursor: pointer; font-size: 16px; transition: 0.2s; }
  .builtin-list button:hover, .custom-list button:hover, .lists button:hover { opacity: 0.85; }
  input, textarea { width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
  button.create { background: var(--accent2); color: white; border: none; padding: 10px 20px; margin-top: 10px; border-radius: 8px; cursor: pointer; }
  ul { list-style: none; padding: 0; width: 100%; }
  li { background: #eef5ff; border-radius: 6px; padding: 8px 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
  li span { color: #333; }
  li button { background: #ff6666; border: none; color: white; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
</style>
</head>
<body>

<h1>é€‰æ‹©æˆ–åˆ›å»ºè¯è¡¨</h1>
<div class="container">
  <!-- å†…ç½®è¯è¡¨ -->
  <h2>ğŸ“˜ å†…ç½®è¯è¡¨</h2>
  <div class="builtin-list" id="builtinList"></div>

  <!-- è‡ªå®šä¹‰è¯è¡¨ -->
  <div class="custom-list">
    <h2>âœï¸ åˆ›å»ºè‡ªå®šä¹‰è¯è¡¨</h2>
    <input id="listName" placeholder="è¯·è¾“å…¥è¯è¡¨åç§°ï¼Œå¦‚â€˜Unit 1 å•è¯â€™">
    <textarea id="wordPairs" rows="5" placeholder="è¾“å…¥å•è¯å’Œä¸­æ–‡ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¦‚ï¼šapple,è‹¹æœ\nbook,ä¹¦"></textarea>
    <button class="create" onclick="createCustomList()">åˆ›å»ºå¹¶åŠ è½½è¯è¡¨</button>
  </div>

  <!-- æˆ‘çš„è‡ªå®šä¹‰è¯è¡¨ -->
  <div class="lists">
    <h2>ğŸ“š æˆ‘çš„è‡ªå®šä¹‰è¯è¡¨</h2>
    <ul id="customLists"></ul>
  </div>
</div>

<script>
const vocabData = [
  {"name":"å¤–ç ”ç¤¾ä¸€å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰","type":"file","path":"words/å°å­¦/å¤–ç ”ç¤¾ä¸€å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"},
  {"name":"å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰","type":"file","path":"words/å°å­¦/å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"},
  {"name":"å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰","type":"file","path":"words/å°å­¦/å¤–ç ”ç¤¾ä¸‰å¹´çº§ï¼ˆä¸‰å¹´çº§èµ·æ­¥ï¼‰.csv"},
  {"name":"å¤–ç ”ç¤¾äºŒå¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰","type":"file","path":"words/å°å­¦/å¤–ç ”ç¤¾äºŒå¹´çº§ï¼ˆä¸€å¹´çº§èµ·æ­¥ï¼‰.csv"},
  {"name":"æµ‹è¯•è¯æ±‡","type":"file","path":"words/æµ‹è¯•/æµ‹è¯•è¯æ±‡.csv"}
];

// ===== è‡ªå®šä¹‰è¯è¡¨ =====
let customLists = JSON.parse(localStorage.getItem('customLists') || '[]');
const ul = document.getElementById('customLists');
renderCustomLists();

function renderCustomLists(){
  ul.innerHTML = '';
  customLists.forEach((list, index)=>{
    const li = document.createElement('li');
    li.innerHTML = `<span>${list.name}ï¼ˆ${list.words.length} ä¸ªè¯ï¼‰</span>
      <div>
        <button onclick="loadCustomList(${index})">åŠ è½½</button>
        <button onclick="deleteCustomList(${index})">åˆ é™¤</button>
      </div>`;
    ul.appendChild(li);
  });
}

function createCustomList(){
  const name = document.getElementById('listName').value.trim();
  const raw = document.getElementById('wordPairs').value.trim();
  if(!name || !raw) return alert('è¯·è¾“å…¥è¯è¡¨åå’Œå•è¯å†…å®¹');
  const lines = raw.split('\n').map(l=>l.split(',')).filter(a=>a.length===2);
  const words = lines.map(([en,cn])=>({en:en.trim(),cn:cn.trim()}));
  customLists.push({name,words});
  localStorage.setItem('customLists', JSON.stringify(customLists));
  renderCustomLists();
  // è‡ªåŠ¨å‘é€ CSV ç»™çˆ¶é¡µé¢
  sendCSVToParent(words.map(w=>`${w.en},${w.cn}`).join('\n'));
}

// åˆ é™¤è‡ªå®šä¹‰è¯è¡¨
function deleteCustomList(index){
  if(!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªè¯è¡¨å—ï¼Ÿ')) return;
  customLists.splice(index,1);
  localStorage.setItem('customLists', JSON.stringify(customLists));
  renderCustomLists();
}

// å‘é€ CSV ç»™çˆ¶é¡µé¢
function sendCSVToParent(csvText){
  if(window.opener && !window.opener.closed){
    window.opener.postMessage({type:"csvData", csv: csvText},"*");
    setTimeout(()=>window.close(),100);
  }else{
    alert("çˆ¶é¡µé¢æœªæ‰¾åˆ°ï¼Œæ— æ³•å¯¼å…¥ CSV");
  }
}

// åŠ è½½è‡ªå®šä¹‰è¯è¡¨
function loadCustomList(index){
  const list = customLists[index];
  const csvText = list.words.map(w=>`${w.en},${w.cn}`).join('\n');
  sendCSVToParent(csvText);
}

// ===== å†…ç½®è¯è¡¨ =====
const builtinContainer = document.getElementById('builtinList');
const folderMap = {};
vocabData.forEach(item=>{
  const parts = item.path.split('/');
  const folder = parts[1];
  const file = parts[2];
  if(!folderMap[folder]) folderMap[folder] = [];
  folderMap[folder].push(file);
});

function renderFolders(){
  builtinContainer.innerHTML='';
  Object.keys(folderMap).forEach(folder=>{
    const btn = document.createElement('button');
    btn.textContent = folder;
    btn.onclick = ()=>renderCSVList(folder);
    builtinContainer.appendChild(btn);
  });
}

function renderCSVList(folder){
  builtinContainer.innerHTML='';
  const backBtn = document.createElement('button');
  backBtn.textContent='â¬… è¿”å›';
  backBtn.onclick = ()=>renderFolders();
  builtinContainer.appendChild(backBtn);

  folderMap[folder].forEach(file=>{
    const btn = document.createElement('button');
    btn.textContent = file.replace('.csv','');
    btn.onclick = async ()=>{
      try{
        const res = await fetch(`words/${folder}/${file}`);
        if(!res.ok) throw new Error("æ–‡ä»¶ä¸å­˜åœ¨");
        const text = await res.text();
        sendCSVToParent(text);
      }catch(e){
        alert("è¯»å– CSV å¤±è´¥ï¼š"+e.message);
      }
    };
    builtinContainer.appendChild(btn);
  });
}

// åˆå§‹æ¸²æŸ“
renderFolders();
</script>
</body>
</html>
