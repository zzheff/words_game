<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>quick_type</title>
  <style>
    :root{--bg:#0b1020;--accent:#ffd166;--danger:#ff5c5c;--ok:#6ee7b7}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#071029 0%, #0b1020 100%);color:#e8eef6;display:flex;justify-content:center;align-items:center;}
    .app{width:960px;max-width:96vw;height:90vh;display:flex;flex-direction:column;gap:12px;}

    .scene{position:relative;border-radius:12px;overflow:hidden;flex:6;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .scene.theme-bomb{background:linear-gradient(180deg,#1b0f0f,#2b1212)}
    .scene.theme-rocket{background:linear-gradient(180deg,#041126,#09203a)}
    .scene.theme-sub{background:linear-gradient(180deg,#001323,#00324a)}
    .scene.theme-zombie{background:linear-gradient(180deg,#071316,#1b1a18)}
    .scene.theme-volcano{background:linear-gradient(180deg,#2b0b00,#3a1a0d)}
    .scene.theme-space{background:linear-gradient(180deg,#030217,#0b1632)}
    .scene.theme-magic{background:linear-gradient(180deg,#0b0920,#241040)}
    .scene.theme-skydive{background:linear-gradient(180deg,#0b2238,#5aa)}

    .panel{flex:4;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));border-radius:12px;padding:18px;display:flex;flex-direction:column;gap:12px;}

    .hintFlash{position:absolute;inset:18px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:600;background:rgba(0,0,0,0.25);backdrop-filter:blur(3px);z-index:5}
    .chinese{position:relative;z-index:5;font-size:36px;font-weight:700;text-align:center;margin-top:40px}
    .countdownBig{position:absolute;right:18px;top:18px;background:rgba(0,0,0,0.25);padding:10px 14px;border-radius:10px;font-weight:700;font-size:22px;z-index:6;}
    .meter{position:absolute;left:18px;top:18px;background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;font-weight:600;z-index:6;}

    .wordTarget{font-size:18px;color:#bcd0e8}
    .feedback{height:40px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .feedback.success{color:var(--ok)}
    .feedback.fail{color:var(--danger)}

    .inputWrap{display:flex;flex-direction:column;gap:12px;align-items:center}
    #letters{display:flex;gap:6px;flex-wrap:nowrap;justify-content:center;margin-top:10px}

    .btn{padding:10px 12px;border-radius:10px;background:var(--accent);color:#0b1020;font-weight:700;border:none;cursor:pointer}

    .letterInput {
      width:28px;
      height:36px;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,0.03);
      padding:6px 8px;
      font-weight:700;
      color:#eaf4ff;
      font-size:18px;
      text-transform:lowercase;
      text-align:center;
      outline:none;
      border:none;
      animation:pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%,100% { box-shadow:0 0 4px rgba(255,255,255,0.3); }
      50% { box-shadow:0 0 12px rgba(255,255,255,0.6); }
    }

    .letterInput.correct{background:rgba(110,231,183,0.15);color:var(--ok)}
    .letterInput.wrong{background:rgba(255,92,92,0.12);color:var(--danger)}

    .explode{animation:explode 700ms ease-out forwards}
    @keyframes explode{0%{transform:scale(1);opacity:1}100%{transform:scale(1.6);opacity:0}}
    .rocketLift{animation:lift 1200ms ease-in forwards}
    @keyframes lift{0%{transform:translateY(0)}100%{transform:translateY(-380px);opacity:0}}

    .bgLayer{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center center;z-index:0;opacity:1;transition:opacity 0.2s linear;}

    #wrongWords {
      font-size:13px;
      color:#ffb3b3;
      border-top:1px solid rgba(255,255,255,0.1);
      background: rgba(255, 255, 255, 0.15);
      padding-top:6px;
      overflow:auto;
      max-height:60px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="scene" class="scene theme-bomb">
      <div class="hintFlash" id="flash" style="display:none">flash</div>
      <div class="countdownBig" id="countdown">--</div>
      <div class="meter" id="themeLabel">Theme</div>
      <div style="position:relative;z-index:4">
        <div class="chinese" id="chinese">â€”â€”</div>
      </div>
      <div id="sceneEffect" style="position:absolute;left:0;right:0;bottom:10px;display:flex;justify-content:center;pointer-events:none"></div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px;color:#bcd0e8">å·²è¿ç»­æˆåŠŸï¼š<span id="streak">0</span></div>
        <button id="importBtn" class="btn">å¯¼å…¥CSV</button>
        <input type="file" id="csvInput" accept=".csv" style="display:none"/>
      </div>

      <div class="inputWrap">
        <button id="startBtn" class="btn">å¼€å§‹</button>
        <div id="letters"></div>
      </div>

      <div class="feedback" id="feedback">ç‚¹å‡»â€œå¼€å§‹â€éšæœºå¼€å§‹ä¸€å±€</div>

      <div style="font-size:13px;color:#9fb4d9">è¯´æ˜ï¼šå…ˆé—ªä¸¤ç§’ä¸­è‹±æ–‡ï¼Œç„¶ååªæ˜¾ç¤ºä¸­æ–‡ã€‚å€’è®¡æ—¶ç»“æŸå‰æ‹¼å†™æ­£ç¡®å¯è¿‡å…³ã€‚</div>

      <div id="wrongWords">é”™è¯è®°å½•ï¼š</div>
    </div>
  </div>


  <script>

    const successSound = new Audio('sounds/success.mp3');
    const failSounds = {
      bomb: new Audio('sounds/bomb_fail.mp3'),
      rocket: new Audio('sounds/rocket_fail.mp3'),
      sub: new Audio('sounds/sub_fail.mp3'),
      zombie: new Audio('sounds/zombie_fail.mp3'),
      volcano: new Audio('sounds/volcano_fail.mp3'),
      space: new Audio('sounds/space_fail.mp3'),
      magic: new Audio('sounds/magic_fail.mp3'),
      skydive: new Audio('sounds/skydive_fail.mp3')
    };

    const wrongWordsEl = document.getElementById('wrongWords');

    const THEMES=[{id:'bomb',name:'æ‹†é™¤ç‚¸å¼¹',time:10},{id:'rocket',name:'ç«ç®­å‘å°„',time:8},{id:'sub',name:'æ°´ä¸‹é€ƒç”Ÿ',time:10},{id:'zombie',name:'åƒµå°¸æ¥è¢­',time:6},{id:'volcano',name:'ç«å±±é€ƒè·‘',time:7},{id:'space',name:'å¤ªç©ºä¿®å¤',time:9},{id:'magic',name:'é­”æ³•å¯¹å†³',time:8},{id:'skydive',name:'é«˜ç©ºå è½',time:10}];

    const scene=document.getElementById('scene'),
          flash=document.getElementById('flash'),
          chineseEl=document.getElementById('chinese'),
          countdownEl=document.getElementById('countdown'),
          themeLabel=document.getElementById('themeLabel'),
          lettersWrap=document.getElementById('letters'),
          startBtn=document.getElementById('startBtn'),
          feedback=document.getElementById('feedback'),
          sceneEffect=document.getElementById('sceneEffect'),
          streakEl=document.getElementById('streak');

    let current=null,timer=null,remain=0,streak=0;
    let _bgFrame = null, _bgBase = null, _bgNext = null;
    let currentTheme = null; // ğŸ”¹æ–°å¢ï¼šå½“å‰ä¸»é¢˜ä¿æŒå˜é‡

    // ---------- èƒŒæ™¯å›¾ç‰‡ ----------
    const THEME_IMAGES = {
      bomb: {typing:['images/bomb.png'], success:['images/bomb_success.png'], fail:['images/bomb_fail.png']},
      rocket: {typing:['images/rocket.png'], success:['images/rocket_success.png'], fail:['images/rocket_fail.png']},
      sub: {typing:['images/sub.png'], success:['images/sub_success.png'], fail:['images/sub_fail.png']},
      zombie: {typing:['images/zombie.png'], success:['images/zombie_success.png'], fail:['images/zombie_fail.png']},
      volcano: {typing:['images/volcano.png'], success:['images/volcano_success.png'], fail:['images/volcano_fail.png']},
      space: {typing:['images/space.png'], success:['images/space_success.png'], fail:['images/space_fail.png']},
      magic: {typing:['images/magic.png'], success:['images/magic_success.png'], fail:['images/magic_fail.png']},
      skydive: {typing:['images/skydive.png'], success:['images/skydive_success.png'], fail:['images/skydive_fail.png']}
    };

    function startBackgroundAnimationWithImages(images, durationSec){
      stopBackgroundAnimation();
      if(!images || images.length === 0) return;
      _bgBase = document.createElement('div');
      _bgBase.className = 'bgLayer';
      _bgBase.style.zIndex = 0;
      _bgBase.style.opacity = 1;
      _bgBase.style.backgroundImage = `url('${images[0]}')`;
      scene.appendChild(_bgBase);

      _bgNext = document.createElement('div');
      _bgNext.className = 'bgLayer';
      _bgNext.style.zIndex = 0;
      _bgNext.style.opacity = 0;
      _bgNext.style.backgroundImage = images.length>1 ? `url('${images[1]}')` : `url('${images[0]}')`;
      scene.appendChild(_bgNext);

      const start = performance.now();
      const lastIndex = images.length - 1;

      function animate(now){
        const elapsed = now - start;
        const t = Math.min(elapsed/(durationSec*1000),1);
        const exactIndex = t*lastIndex;
        const lower = Math.floor(exactIndex);
        const upper = Math.min(lower+1,lastIndex);
        const frac = exactIndex - lower;

        _bgBase.style.backgroundImage = `url('${images[lower]}')`;
        _bgNext.style.backgroundImage = `url('${images[upper]}')`;
        _bgNext.style.opacity = frac;

        if(t<1){ _bgFrame=requestAnimationFrame(animate); }
        else { _bgBase.style.backgroundImage = `url('${images[lastIndex]}')`; _bgNext.style.opacity=0; _bgFrame=null; }
      }

      _bgFrame=requestAnimationFrame(animate);
    }

    function stopBackgroundAnimation(){
      if(_bgFrame){ cancelAnimationFrame(_bgFrame); _bgFrame=null; }
      if(_bgBase){ try{ scene.removeChild(_bgBase);}catch(e){} _bgBase=null; }
      if(_bgNext){ try{ scene.removeChild(_bgNext);}catch(e){} _bgNext=null; }
    }

    // ------------------ CSV å¯¼å…¥å•è¯ï¼ˆæ•´é¡µè·³è½¬ SPA ç‰ˆæœ¬ï¼‰ ------------------
    let importedWords = [];
    let remainingWords = []; // ä¿å­˜å½“å‰æœªç­”å¯¹çš„å•è¯

    function pickRandomWord() {
      if (remainingWords.length === 0) {
        alert('ğŸ‰ æ‰€æœ‰å•è¯éƒ½å·²å®Œæˆï¼è¯·é‡æ–°å¯¼å…¥æˆ–åˆ·æ–°é¡µé¢ã€‚');
        return null;
      }
      return remainingWords[Math.floor(Math.random() * remainingWords.length)];
    }

    const importBtn = document.getElementById('importBtn');

    // === ç‚¹å‡»æŒ‰é’®ï¼šæ•´é¡µè·³è½¬åˆ° WordList.html ===
    importBtn.addEventListener('click', () => {
      const returnURL = encodeURIComponent(window.location.pathname);
      window.location.href = `../public/WordList.html?returnURL=${returnURL}`;
    });

    // === é¡µé¢è½½å…¥åï¼šè‡ªåŠ¨æ£€æŸ¥ localStorage æ˜¯å¦æœ‰è¯è¡¨ ===
    window.addEventListener("DOMContentLoaded", () => {
      const csvText = localStorage.getItem("csv_data");
      if (!csvText) return;

      // ç”¨å®Œå³åˆ ï¼Œé¿å…å¤šæ¬¡è§¦å‘
      localStorage.removeItem("csv_data");

      const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
      importedWords = [];

      for (const line of lines) {
        const parts = line.split(',');
        if (parts.length < 2) continue;

        const col1 = parts[0].trim();
        const col2 = parts[1]?.trim() || '';

        if (!col1 || !col2) continue;

        let eng = '', chi = '';

        // åˆ¤æ–­å“ªä¸€åˆ—æ˜¯è‹±æ–‡
        if (/[a-zA-Z]/.test(col1) && !/[\u4e00-\u9fa5]/.test(col1)) {
          eng = col1; chi = col2;
        } else if (/[a-zA-Z]/.test(col2) && !/[\u4e00-\u9fa5]/.test(col2)) {
          eng = col2; chi = col1;
        } else {
          eng = col1; chi = col2;
        }

        importedWords.push([eng, chi]);
      }

      if (importedWords.length > 0) {
        remainingWords = [...importedWords];
        alert(`âœ… å·²åŠ è½½ ${importedWords.length} ä¸ªå•è¯ï¼`);
        feedback.textContent = 'è¯è¡¨å·²åŠ è½½ï¼Œç‚¹å‡»â€œå¼€å§‹â€å¼€å§‹æ¸¸æˆ';
      } else {
        alert('âš ï¸ æœªæ£€æµ‹åˆ°æœ‰æ•ˆå•è¯æ•°æ®');
      }
    });
    // ------------------ å¼€å§‹ä¸€å±€ ------------------
    function renderLettersInputs(target){
      lettersWrap.innerHTML='';
      for(let i=0;i<target.length;i++){
        const input=document.createElement('input');
        input.className='letterInput';
        input.maxLength=1;
        lettersWrap.appendChild(input);
      }
      const inputs=lettersWrap.querySelectorAll('input');
      inputs.forEach((input,idx)=>{
        input.addEventListener('input',e=>{
          const val=e.target.value.toLowerCase();
          if(val && idx<inputs.length-1)inputs[idx+1].focus();
          checkProgress();
        });
        input.addEventListener('keydown',e=>{
          if(e.key==='Backspace' && !input.value && idx>0){inputs[idx-1].focus();}
          if(e.key==='Enter'){checkProgress(); onTimeUp();}
        });
      });
      inputs[0].focus();
    }

    function startRound(){
      const wordPair = pickRandomWord();
      if (!wordPair) return;
      feedback.textContent='å‡†å¤‡ä¸­...';
      const [eng,chi] = wordPair;
      // ğŸ”¹ ä¿æŒä¸Šä¸€ä¸ªä¸»é¢˜ä¸å˜
      if (!currentTheme) currentTheme = pickRandomTheme();
      current={eng,chi,theme:currentTheme};
      setThemeVisual(currentTheme.id);
      showFlash(eng,chi);
      chineseEl.textContent=chi;
      setTimeout(()=>{
        renderLettersInputs(eng);
        feedback.textContent='å¼€å§‹æ‹¼å†™...';
        remain=currentTheme.time;
        countdownEl.textContent=remain+'s';
        if(timer){ clearInterval(timer); timer=null; }
        stopBackgroundAnimation();

        const typingImages = THEME_IMAGES[current.theme.id].typing;
        startBackgroundAnimationWithImages(typingImages, current.theme.time);

        timer=setInterval(()=>{
          if(remain>0){ remain-=1; countdownEl.textContent=remain+'s'; }
          else{ clearInterval(timer); timer=null; countdownEl.textContent='0s'; onTimeUp(); }
        },1000);

      },2000);
    }

    function getTypedWord(){return Array.from(lettersWrap.querySelectorAll('input')).map(i=>i.value).join('');}

    function checkProgress(){
      const typed = getTypedWord();
      const target = current.eng;
      const inputs = lettersWrap.querySelectorAll('input');
      if(current.wrongRecorded && typed.toLowerCase()===target.toLowerCase()){ current.wrongRecorded=false; }
      for(let i=0;i<inputs.length;i++){
        inputs[i].classList.remove('correct','wrong');
        if(i<typed.length){
          if(typed[i].toLowerCase()===target[i].toLowerCase()) inputs[i].classList.add('correct');
          else inputs[i].classList.add('wrong');
        }
      }
      if(typed.toLowerCase()===target.toLowerCase()){
        if(timer){ clearInterval(timer); timer=null; }
        onSuccess();
      }
    }

    function onTimeUp(){ const typed=getTypedWord(); if(typed.toLowerCase()===current.eng.toLowerCase()) onSuccess(); else onFail(); }

    function onSuccess(){
      feedback.className='feedback success';
      feedback.textContent='æˆåŠŸï¼è¿‡å…³ã€‚';
      // âœ… ä»å‰©ä½™å•è¯ä¸­ç§»é™¤å½“å‰å·²ç­”å¯¹çš„
      remainingWords = remainingWords.filter(([eng, chi]) => eng !== current.eng);
      successSound.play();
      streak++;streakEl.textContent=streak;

      const successImages = THEME_IMAGES[current.theme.id].success;
      startBackgroundAnimationWithImages(successImages, 1.2);

      sceneEffect.innerHTML=`<div class="${current.theme.id==='rocket'?'rocketLift':'explode'}"></div>`;

      // ğŸ”¹ å€’è®¡æ—¶é‡ç½®å¹¶è¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
      setTimeout(()=>{ startRound(); }, 1200);
    }

    function onFail(){
      feedback.className='feedback fail';
      feedback.textContent='å¤±è´¥ï¼æ—¶é—´åˆ°æˆ–æ‹¼å†™é”™è¯¯';
      streak=0;streakEl.textContent=streak;

      const failSound=failSounds[current.theme.id];
      if(failSound) failSound.play();

      if(!current.wrongRecorded){
        wrongWordsEl.textContent += '\n'+current.eng+' â€” '+current.chi;
        current.wrongRecorded=true;
      }

      const failImages = THEME_IMAGES[current.theme.id].fail;
      startBackgroundAnimationWithImages(failImages, 1.2);

      sceneEffect.innerHTML=`<div class="explode"></div>`;

      // âœ… æ–°å¢é€»è¾‘ï¼šç­”é”™ååˆ‡æ¢ä¸»é¢˜
      const newTheme = (() => {
        let t;
        do { t = pickRandomTheme(); }
        while (t.id === current.theme.id);
        return t;
      })();
      currentTheme = newTheme; // æ›´æ–°å½“å‰ä¸»é¢˜
      setThemeVisual(newTheme.id);

      // âœ… å»¶è¿Ÿåè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå•è¯
      setTimeout(()=>{ startRound(); }, 1200);
    }

    function pickRandomTheme(){return THEMES[Math.floor(Math.random()*THEMES.length)];}

    function setThemeVisual(themeId){
      scene.className='scene theme-'+themeId;
      themeLabel.textContent=THEMES.find(t=>t.id===themeId).name;
    }

    function showFlash(eng,chi){
      flash.style.display='flex';
      flash.textContent=`${eng} â€” ${chi}`;
      setTimeout(()=>{ flash.style.display='none'; },2000);
    }

    startBtn.addEventListener('click',startRound);



  </script>

</body>
</html>
