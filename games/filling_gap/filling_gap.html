<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>filling_gap</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  text-align: center;
  background: url('sky.jpg') no-repeat center center;
  background-size: cover;
  background-attachment: fixed;
  overflow: hidden;
}
h1 { margin:10px 0; color:#333; }

#overlay {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:1000;
  gap: 20px;
}
#overlay button {
  padding: 1em 2em;
  font-size: 1.2em;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

/* 猫选择区域 */
#catSelect {
  display: flex;
  gap: 15px;
  justify-content: center;
  align-items: center;
}
#catSelect img {
  width: 60px;
  height: 60px;
  cursor: pointer;
  border: 2px solid transparent;
  border-radius: 50%;
  transition: transform 0.2s, border 0.2s;
}
#catSelect img.selected {
  border-color: #fff;
  transform: scale(1.2);
}

#gameWrapper {
  position: absolute;
  left: 50%;
  top: 45%;
  transform: translate(-50%, -50%);
  width: 60vw;
  height: 60vh;
  overflow: hidden;
  border: 3px solid #333;
  background: #a3d9f7;
  border-radius: 10px;
}
#gameContainer {
  position: absolute;
  bottom: 0;
  width: 100%;
  transition: transform 0.5s;
}
.floor {
  position: relative;
  width: 100%;
  height: 100%;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#3498db;
  margin-bottom:10px;
  border-radius:5px;
  color:#fff;
  font-size: 4vw;
  font-weight:bold;
  text-shadow:1px 1px #000;
}
#cat {
  position: absolute;
  width: 8vw;
  height: 8vw;
  bottom: 25%;
  transition: left 0.5s, bottom 0.5s;
  z-index:2;
  background: url('cat.png') no-repeat center/contain;
}
#cnHint {
  position: absolute;
  top: 5%;
  left: 5%;
  font-size: 1.8vw;
  color: #333;
  font-weight: bold;
  z-index: 10;
  background: rgba(255,255,255,0.8);
  padding: 0.3em 0.6em;
  border-radius: 5px;
}
.wordWrapper {
  position: absolute;
  top: 78%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 3vw;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:0.2em;
  z-index: 10;
}
input.missing {
  width: 1.2em;
  font-size: 3vw;
  text-align:center;
  border-radius: 4px;
  color: #000;
  text-shadow: 1px 1px #fff;
}
#submitBtn {
  position: absolute;
  bottom: 5px;
  left: 50%;
  transform: translateX(-50%);
  padding: 0.6em 1.2em;
  font-size: 1.2rem;
  cursor: pointer;
  z-index: 10;
  border-radius: 8px;
  white-space: nowrap;
  max-width: 90%;
  background: #fff;
  color: #333;
  border: 2px solid #333;
}

/* === 结束弹窗样式 === */
#endOverlay {
  display:none;
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.7);
  z-index:2000;
  justify-content:center;
  align-items:center;
  flex-direction:column;
}
#endOverlay img {
  max-width:60%;
  border-radius:10px;
  margin-bottom:1em;
}
#endOverlay button {
  padding:0.8em 1.5em;
  font-size:1.2em;
  border-radius:8px;
  cursor:pointer;
  margin:0 0.5em;
}
</style>
</head>
<body>

<h1>和猫咪一起旅游</h1>

<!-- 遮罩层 -->
<div id="overlay">
  <!-- 猫选择 -->
  <div id="catSelect">
    <img src="cat1.png" class="catOption selected">
    <img src="cat2.png" class="catOption">
    <img src="cat3.png" class="catOption">
    <img src="cat4.png" class="catOption">
    <img src="cat5.png" class="catOption">
  </div>
  <button id="importBtn">导入词汇</button>
</div>

<div id="gameWrapper" style="display:none;">
  <div id="gameContainer"></div>
  <div id="cat"></div>
  <div id="cnHint"></div>
  <div id="wordDisplay" class="wordWrapper"></div>
  <button id="submitBtn">提交</button>
</div>

<!-- 音效 -->
<audio id="correctSound" src="correct.mp3" preload="auto"></audio>
<audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>

<!-- 结束弹窗 -->
<div id="endOverlay">
  <img id="endImage" src="end.png">
  <audio id="endSound" src="end.mp3" preload="auto"></audio>
  <div>
    <button id="endBtn">结束游戏</button>
    <button id="restartBtn">再来一轮</button>
  </div>
</div>

<script>
let floors = [];
const totalFloors = 15;
const floorHeight = 100;
let currentFloor = 0;
let currentIndex = 0;
let jumpLeft = true;

const container = document.getElementById('gameContainer');
const cat = document.getElementById('cat');
const wordDisplay = document.getElementById('wordDisplay');
const cnHint = document.getElementById('cnHint');
const submitBtn = document.getElementById('submitBtn');

const correctSound = document.getElementById('correctSound');
const wrongSound = document.getElementById('wrongSound');

const overlay = document.getElementById('overlay');
const importBtn = document.getElementById('importBtn');

// ======= 从 WordList.html 返回的词表 =======
window.addEventListener('load', () => {
  const selectedWordList = JSON.parse(sessionStorage.getItem('selectedWordList'));
  if (selectedWordList && selectedWordList.words && selectedWordList.words.length>0) {
    floors = selectedWordList.words.map(w => ({ en: w.en, cn: w.cn, word: w.en }));
    overlay.style.display = 'none';
    startGame();
  }
});

// ======= 导入按钮跳转 WordList.html =======
importBtn.addEventListener('click', () => {
  window.location.href = '../public/WordList.html';
});

// ======= 游戏逻辑函数 =======
function startGame() {
  document.getElementById('gameWrapper').style.display = 'block';
  currentFloor = 0;
  currentIndex = 0;
  pickRandomBackgrounds();
  preloadBackgrounds();
  initFloors();
  updateWord();
  moveCat(currentFloor);
}

function initFloors() {
  container.innerHTML = '';
  for (let i = 0; i < totalFloors; i++) {
    const floorDiv = document.createElement('div');
    floorDiv.className = 'floor';
    floorDiv.style.bottom = i * (floorHeight + 10) + 'px';
    floorDiv.textContent = `Floor ${i + 1}`;
    container.appendChild(floorDiv);
  }
}

function updateWord() {
  wordDisplay.innerHTML = '';
  let wordObj = floors[currentIndex % floors.length];
  let word = wordObj.word;
  cnHint.textContent = wordObj.cn;

  const displayIndex = Math.floor(Math.random() * word.length);
  for (let i = 0; i < word.length; i++) {
    if (i === displayIndex) {
      let span = document.createElement('span');
      span.textContent = word[i];
      span.style.color = '#000';
      span.style.textShadow = '1px 1px 2px #fff';
      wordDisplay.appendChild(span);
    } else {
      let inp = document.createElement('input');
      inp.className = 'missing';
      inp.maxLength = 1;
      inp.addEventListener('input', function() {
        this.value = this.value.slice(-1);
        const inputs = Array.from(wordDisplay.querySelectorAll('input.missing'));
        const idx = inputs.indexOf(this);
        if (idx < inputs.length - 1) inputs[idx + 1].focus();
      });
      inp.addEventListener('keydown', function(e) {
        if (e.key==='Backspace') {
          const inputs = Array.from(wordDisplay.querySelectorAll('input.missing'));
          const idx = inputs.indexOf(this);
          if(this.value==='' && idx>0) {inputs[idx-1].focus(); inputs[idx-1].value=''; e.preventDefault();}
        }
      });
      wordDisplay.appendChild(inp);
    }
  }
  submitBtn.style.top = (wordDisplay.offsetTop + wordDisplay.offsetHeight + 5) + 'px';
}

submitBtn.addEventListener('click', checkWord);

function checkWord() {
  let wordObj = floors[currentIndex % floors.length];
  const children = wordDisplay.children;
  let correct = true;
  for (let i = 0; i < children.length; i++) {
    if (children[i].tagName === 'INPUT') {
      if (children[i].value.toLowerCase() !== wordObj.word[i]) {correct = false; break;}
    }
  }
  if(correct){
    correctSound.play();
    currentFloor = Math.min(currentFloor + 1, totalFloors - 1);
    currentIndex++;
    if(currentIndex >= floors.length){showEndOverlay(); return;}
    moveCat(currentFloor);
    updateWord();
  } else {
    wrongSound.play();
    const inputs = wordDisplay.querySelectorAll('input.missing');
    inputs.forEach(input => input.value='');
    inputs[0].focus();
  }
}

// === 随机背景逻辑 ===
const totalBackgrounds = 28;
const extensions = ['jpg'];
let floorBackgrounds = [];

function pickRandomBackgrounds() {
  const allBGs = [];
  for(let i=1;i<=totalBackgrounds;i++){
    extensions.forEach(ext => allBGs.push(`bg${i}.${ext}`));
  }
  floorBackgrounds = [];
  const used = new Set();
  while(floorBackgrounds.length < totalFloors) {
    const idx = Math.floor(Math.random() * allBGs.length);
    const bg = allBGs[idx];
    if(!used.has(bg)){
      floorBackgrounds.push(bg);
      used.add(bg);
    }
  }
}

function preloadBackgrounds() {
  floorBackgrounds.forEach(src => { const img = new Image(); img.src = src; });
}

function moveCat(floor){
  const start = parseFloat(cat.style.bottom)||25;
  cat.style.bottom = start+15+'%';
  setTimeout(()=>{cat.style.bottom=start+'%';},200);
  cat.style.left = jumpLeft?'30%':'70%';
  jumpLeft = !jumpLeft;
  moveFocus(floor);
}
function moveFocus(floor){
  const scrollY = floor*(floorHeight+10);
  container.style.transform = `translateY(-${scrollY}px)`;
  const wrapper = document.getElementById('gameWrapper');
  const bg = floorBackgrounds[floor%floorBackgrounds.length];
  wrapper.style.background = `url('${bg}') no-repeat center/cover`;
}

// === 猫选择逻辑 ===
const catOptions = document.querySelectorAll('#catSelect .catOption');
catOptions.forEach(img => {
  img.addEventListener('click', () => {
    catOptions.forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
    cat.style.background = `url('${img.src}') no-repeat center/contain`;
  });
});

// === 结束弹窗功能 ===
const endOverlay = document.getElementById('endOverlay');
const endSound = document.getElementById('endSound');

document.getElementById('endBtn').addEventListener('click', ()=>{
  location.reload();
});

document.getElementById('restartBtn').addEventListener('click', ()=>{
  endOverlay.style.display='none';
  startGame();
});

function showEndOverlay(){
  endOverlay.style.display='flex';
  endSound.currentTime=0;
  endSound.play();
  endOverlay.onclick = ()=>{endSound.pause();};
}

</script>

</body>
</html>
